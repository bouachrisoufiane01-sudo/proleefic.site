<script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, deleteDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // 1. CONFIGURATION (Your Keys)
        const firebaseConfig = {
            apiKey: "AIzaSyBsPi64Eb0GQnGjcxg6n6YRFbG-iO9K_pM",
            authDomain: "proleefic-85800.firebaseapp.com",
            projectId: "proleefic-85800",
            storageBucket: "proleefic-85800.firebasestorage.app",
            messagingSenderId: "1033605555868",
            appId: "1:1033605555868:web:577ff42f0bcfb0b6122f59",
            measurementId: "G-WJ4XKS01P0"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // 2. TRANSLATIONS
        const i18n = {
            en: { heroTitle: "Find the job that fits your life", whatLabel: "What", whereLabel: "Where", searchPlaceholder: "Job title, keywords...", searchBtn: "Find Jobs", cvTitle: "Post your CV", cvSub: "It only takes a few seconds", uploadBtn: "Upload Resume", categories: "Job Categories", feedTitle: "Job Feed", loadMore: "Refresh Jobs", hiringNow: "Hiring Now", authTitle: "Welcome Back", authSub: "Access your profile, save jobs, and apply instantly.", backHome: "Back to Jobs", logout: "Logout", savedJobs: "Saved Jobs", easyApply: "Easy Apply", urgent: "Urgent", posted: "Posted", ago: "ago", applyOn: "Apply on", loginBtn: "Sign In", cat_prod: "Production & Manufacturing", cat_tech: "Technicians & Maintenance", cat_eng: "Engineering & Civil", cat_it: "IT & Digital", cat_sales: "Sales & Commercial", cat_admin: "Admin & Finance", cat_transport: "Transport & Logistics" },
            fr: { heroTitle: "Trouvez le job qui correspond à votre vie", whatLabel: "Quoi", whereLabel: "Où", searchPlaceholder: "Titre, mots-clés...", searchBtn: "Rechercher", cvTitle: "Déposez votre CV", cvSub: "Cela ne prend que quelques secondes", uploadBtn: "Télécharger CV", categories: "Catégories", feedTitle: "Offres d'emploi", loadMore: "Actualiser", hiringNow: "Recrute Actuellement", authTitle: "Bienvenue", authSub: "Accédez à votre profil et postulez instantanément.", backHome: "Retour aux offres", logout: "Déconnexion", savedJobs: "Offres Sauvegardées", easyApply: "Candidature Simple", urgent: "Urgent", posted: "Publié il y a", ago: "", applyOn: "Postuler sur", loginBtn: "Connexion", cat_prod: "Production & Industrie", cat_tech: "Techniciens & Maintenance", cat_eng: "Ingénierie & BTP", cat_it: "Informatique & Digital", cat_sales: "Commercial & Vente", cat_admin: "Admin & Finance", cat_transport: "Transport & Logistique" },
            ar: { heroTitle: "جد الوظيفة التي تناسب حياتك", whatLabel: "ماذا", whereLabel: "أين", searchPlaceholder: "المسمى الوظيفي...", searchBtn: "بحث", cvTitle: "ارفع سيرتك الذاتية", cvSub: "ثوانٍ فقط", uploadBtn: "تحميل السيرة الذاتية", categories: "تصنيفات الوظائف", feedTitle: "أحدث الوظائف", loadMore: "تحديث الوظائف", hiringNow: "يوظفون الآن", authTitle: "مرحباً بعودتك", authSub: "سجل الدخول لحفظ الوظائف والتقديم.", backHome: "العودة للوظائف", logout: "خروج", savedJobs: "الوظائف المحفوظة", easyApply: "تقديم سريع", urgent: "عاجل", posted: "نشر منذ", ago: "", applyOn: "التقديم عبر", loginBtn: "تسجيل الدخول", cat_prod: "الإنتاج والتصنيع", cat_tech: "الفنيين والصيانة", cat_eng: "الهندسة والبناء", cat_it: "تكنولوجيا المعلومات", cat_sales: "المبيعات والتجارة", cat_admin: "الإدارة والمالية", cat_transport: "النقل واللوجستيك" }
        };

        window.currentLang = localStorage.getItem('lang') || 'en';
        window.currentUser = null;
        window.jobs = [];

        // 3. STARTUP LOGIC
        window.onload = () => { 
            // Ensure dark mode preference is respected immediately
            if(localStorage.getItem('theme') === 'dark') document.documentElement.classList.add('dark');
            
            setLang(window.currentLang); 
            
            // Force Generate Data immediately to prevent empty screen
            window.initData(); 
        };

        // 4. CORE FUNCTIONS
        window.setLang = (lang) => {
            window.currentLang = lang; 
            localStorage.setItem('lang', lang); 
            document.documentElement.setAttribute('dir', lang === 'ar' ? 'rtl' : 'ltr');
            
            // Update Buttons
            document.querySelectorAll('.lang-btn').forEach(b => { 
                b.classList.remove('bg-white', 'dark:bg-gray-700', 'text-morocco-green', 'shadow-sm'); 
                b.classList.add('text-gray-500'); 
            });
            const activeBtn = document.getElementById('lang-' + lang);
            if(activeBtn) {
                activeBtn.classList.add('bg-white', 'dark:bg-gray-700', 'text-morocco-green', 'shadow-sm'); 
                activeBtn.classList.remove('text-gray-500');
            }

            // Translate UI
            document.querySelectorAll('[data-i18n]').forEach(el => { 
                if(i18n[lang][el.getAttribute('data-i18n')]) el.innerText = i18n[lang][el.getAttribute('data-i18n')]; 
            });
            document.querySelectorAll('[data-placeholder]').forEach(el => { 
                if(i18n[lang][el.getAttribute('data-placeholder')]) el.placeholder = i18n[lang][el.getAttribute('data-placeholder')]; 
            });
            
            renderCategories(); 
            if(window.jobs.length > 0) renderJobs(window.jobs);
        };

        window.toggleTheme = () => { 
            document.documentElement.classList.toggle('dark'); 
            localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light'); 
        }

        window.switchView = (v) => { 
            document.querySelectorAll('.view-section').forEach(e => e.classList.add('hidden-view')); 
            document.getElementById(v+'View').classList.remove('hidden-view'); 
            window.scrollTo(0,0); 
        }

        // 5. DATA LOADING (THE FIX)
        window.initData = async () => {
            const cities = ['Casablanca', 'Tanger', 'Kenitra', 'Rabat', 'El Jadida', 'Agadir', 'Fes', 'Marrakech']; 
            const locFilter = document.getElementById('locationFilter');
            if(locFilter) {
                locFilter.innerHTML = `<option value="">${i18n[currentLang].whereLabel || 'All Cities'}</option>` + cities.map(c => `<option value="${c}">${c}</option>`).join('');
            }
            
            // Show Spinner
            const list = document.getElementById('jobListings');
            if(list) list.innerHTML = `<div class="text-center py-12"><i class="fa-solid fa-circle-notch fa-spin text-4xl text-morocco-green"></i></div>`;

            try {
                // Try to fetch real file
                const response = await fetch('jobs.json?t=' + Date.now());
                if (!response.ok) throw new Error("No file");
                const realJobs = await response.json();
                window.jobs = realJobs;
                renderJobs(window.jobs);
                console.log("Loaded from JSON");
            } catch (e) {
                console.warn("⚠️ JSON not found, generating backup data...", e);
                generateBackupData(); // FORCE GENERATE
            }
        };

        function generateBackupData() {
            const types = [
                { t: "Opérateur de Production", c: "cat_prod", sal: "3000 - 4500 MAD" }, 
                { t: "Technicien de Maintenance", c: "cat_tech", sal: "4500 - 7000 MAD" }, 
                { t: "Ingénieur Mécanique", c: "cat_eng", sal: "9000 - 13000 MAD" }, 
                { t: "Développeur Full Stack", c: "cat_it", sal: "12000 MAD+" }, 
                { t: "Commercial Terrain", c: "cat_sales", sal: "Fixed + Comm" },
                { t: "Chauffeur Poids Lourd", c: "cat_transport", sal: "5000 MAD" },
                { t: "Comptable Senior", c: "cat_admin", sal: "8000 MAD" }
            ];
            const companies = ['Renault Tanger', 'Yazaki', 'OCP Group', 'Maroc Telecom', 'Dell', 'Lear Corp', 'Stellantis'];
            const cities = ['Casablanca', 'Tanger', 'Rabat', 'Kenitra'];
            const newJobs = [];
            
            for(let i=0; i<40; i++) { 
                const type = types[Math.floor(Math.random() * types.length)]; 
                const comp = companies[Math.floor(Math.random() * companies.length)]; 
                
                newJobs.push({ 
                    id: Date.now() + i, 
                    title: type.t, 
                    company: comp, 
                    location: cities[Math.floor(Math.random() * cities.length)], 
                    catId: type.c, 
                    salary: type.sal, 
                    posted: Math.floor(Math.random() * 7), 
                    urgent: Math.random() > 0.7, 
                    easyApply: Math.random() > 0.5, 
                    rating: (3.5 + Math.random() * 1.5).toFixed(1), 
                    link: "https://www.linkedin.com/jobs/search/?keywords=Morocco", 
                    sourceName: "Direct Apply" 
                }); 
            }
            window.jobs = newJobs;
            renderJobs(window.jobs);
        }

        function renderCategories() {
            const list = document.getElementById('categoryList');
            if(!list) return;
            
            const cats = [
                { id: 'cat_prod', icon: 'fa-industry' }, 
                { id: 'cat_tech', icon: 'fa-wrench' }, 
                { id: 'cat_eng', icon: 'fa-helmet-safety' }, 
                { id: 'cat_transport', icon: 'fa-truck' }, 
                { id: 'cat_it', icon: 'fa-laptop-code' }, 
                { id: 'cat_sales', icon: 'fa-briefcase' }
            ];
            
            list.innerHTML = cats.map(c => `
                <button onclick="filterCat('${c.id}')" class="w-full text-left px-4 py-3 hover:bg-gray-50 dark:hover:bg-gray-700/50 flex items-center gap-3 transition group">
                    <span class="text-gray-400 group-hover:text-morocco-green"><i class="fa-solid ${c.icon}"></i></span>
                    <span class="text-sm font-medium text-gray-700 dark:text-gray-300 group-hover:text-gray-900 dark:group-hover:text-white">
                        ${i18n[currentLang][c.id] || c.id}
                    </span>
                </button>`).join('');
        }

        function renderJobs(arr) {
            const container = document.getElementById('jobListings');
            if(!container) return;
            
            document.getElementById('jobCount').innerText = arr.length + ' jobs';
            
            container.innerHTML = arr.map((j, idx) => {
                const timeText = j.posted === 0 ? (currentLang === 'ar' ? 'اليوم' : 'Today') : `${currentLang === 'ar' ? '' : i18n[currentLang].posted} ${j.posted}d ${i18n[currentLang].ago}`;
                
                let adBlock = ''; 
                if(idx === 4) { 
                    adBlock = `<div class="ad-container py-4 my-4"><span class="ad-label">Sponsored</span><ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-3965710509874164" data-ad-slot="REPLACE_WITH_SLOT_ID"></ins><script>(adsbygoogle = window.adsbygoogle || []).push({});<\/script></div>`; 
                }
                
                return `${adBlock}
                <div class="bg-white dark:bg-dark-card p-5 rounded-xl border border-gray-200 dark:border-gray-700 hover:border-morocco-green hover:shadow-lg transition-all animate-fade-in group relative" style="animation-delay: ${idx * 0.05}s">
                    ${j.urgent ? `<span class="absolute top-0 right-0 bg-red-100 text-morocco-red text-[10px] font-bold px-2 py-1 rounded-bl-lg rounded-tr-lg uppercase tracking-wide"><i class="fa-solid fa-fire mr-1"></i>${i18n[currentLang].urgent}</span>` : ''}
                    <div class="flex gap-4">
                        <div class="w-12 h-12 rounded bg-white border border-gray-200 flex items-center justify-center font-bold text-gray-700 shrink-0 text-xl">${j.company[0]}</div>
                        <div class="flex-1">
                            <h3 class="font-bold text-lg text-gray-800 dark:text-white group-hover:text-morocco-green transition-colors mb-0.5">${j.title}</h3>
                            <div class="text-sm text-gray-700 dark:text-gray-300 mb-2">${j.company} <span class="text-xs text-gray-400">★ ${j.rating}</span></div>
                            <div class="text-sm text-gray-500 mb-3 flex items-center gap-1"><i class="fa-solid fa-location-dot text-xs"></i> ${j.location}</div>
                            <div class="flex flex-wrap gap-2 mb-3"><span class="bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 text-xs font-bold px-2 py-1 rounded flex items-center gap-1"><i class="fa-solid fa-money-bill-wave"></i> ${j.salary}</span></div>
                            <div class="text-xs text-gray-400 mb-4">${timeText}</div>
                            <div class="flex gap-3">
                                <a href="${j.link}" target="_blank" class="flex-1 bg-morocco-green text-white text-center py-2.5 rounded-lg text-sm font-bold hover:bg-morocco-darkGreen transition shadow-sm flex items-center justify-center gap-2">${i18n[currentLang].applyOn} ${j.sourceName} <i class="fa-solid fa-arrow-up-right-from-square text-xs"></i></a>
                                <button onclick="toggleSave(${j.id})" class="px-4 py-2 border border-gray-200 dark:border-gray-600 rounded-lg text-gray-400 hover:text-morocco-red hover:border-morocco-red transition"><i class="fa-regular fa-heart text-lg"></i></button>
                            </div>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        // 6. FILTERS
        window.filter = () => { 
            const term = document.getElementById('mainSearch').value.toLowerCase(); 
            const loc = document.getElementById('locationFilter').value; 
            renderJobs(window.jobs.filter(j => (j.title.toLowerCase().includes(term) || j.company.toLowerCase().includes(term)) && (loc === '' || j.location === loc))); 
        };
        window.filterCat = (catId) => renderJobs(window.jobs.filter(j => j.catId === catId));
        window.setCategory = (val) => window.filterCat(val);

        // 7. AUTH ACTIONS
        window.toggleAuthMode = (mode) => {
            document.getElementById('authError').classList.add('hidden');
            const loginForm = document.getElementById('loginForm');
            const signupForm = document.getElementById('signupForm');
            const tLogin = document.getElementById('tab-login');
            const tSignup = document.getElementById('tab-signup');
            
            if(mode === 'login') { 
                loginForm.classList.remove('hidden'); signupForm.classList.add('hidden'); 
                tLogin.classList.add('bg-white', 'text-morocco-green'); tLogin.classList.remove('text-gray-500');
                tSignup.classList.remove('bg-white', 'text-morocco-green'); tSignup.classList.add('text-gray-500');
            } else { 
                loginForm.classList.add('hidden'); signupForm.classList.remove('hidden'); 
                tSignup.classList.add('bg-white', 'text-morocco-green'); tSignup.classList.remove('text-gray-500');
                tLogin.classList.remove('bg-white', 'text-morocco-green'); tLogin.classList.add('text-gray-500');
            }
        }
        window.openAuth = () => document.getElementById('authView').classList.remove('hidden-view'); // Quick open
        window.showError = (msg) => { const e = document.getElementById('authError'); e.classList.remove('hidden'); document.getElementById('authErrorMsg').innerText = msg.replace('Firebase: ', ''); }
        window.handlePasswordReset = () => { const email = document.getElementById('loginEmail').value; if(!email) return showError("Enter email first."); sendPasswordResetEmail(auth, email).then(() => alert("Email sent!")).catch(e => showError(e.message)); }
        window.handleEmailLogin = (e) => { e.preventDefault(); signInWithEmailAndPassword(auth, document.getElementById('loginEmail').value, document.getElementById('loginPass').value).then(() => switchView('profile')).catch(err => showError(err.message)); };
        window.handleEmailSignup = (e) => { e.preventDefault(); const name = document.getElementById('signupName').value; createUserWithEmailAndPassword(auth, document.getElementById('signupEmail').value, document.getElementById('signupPass').value).then((res) => { updateProfile(res.user, { displayName: name }); switchView('profile'); }).catch(err => showError(err.message)); };
        window.loginGoogle = () => { signInWithPopup(auth, new GoogleAuthProvider()).then(() => switchView('profile')).catch(e => showError(e.message)); }
        window.logout = () => signOut(auth).then(() => switchView('home'));

        onAuthStateChanged(auth, (user) => {
            window.currentUser = user; const sec = document.getElementById('authSection');
            if(user) { sec.innerHTML = `<button onclick="switchView('profile')" class="font-bold text-sm text-gray-700 dark:text-gray-200 hover:text-morocco-green flex items-center gap-2"><div class="w-8 h-8 rounded-full bg-morocco-red text-white flex items-center justify-center font-bold">${user.displayName?user.displayName[0]:'U'}</div> <span class="hidden sm:inline">${user.displayName || 'User'}</span></button>`; document.getElementById('userName').innerText = user.displayName || "User"; document.getElementById('userEmail').innerText = user.email; loadSavedJobs(); }
            else { sec.innerHTML = `<button onclick="switchView('auth')" class="bg-morocco-green text-white px-5 py-2 rounded-lg font-bold text-sm hover:bg-morocco-darkGreen transition shadow-sm" data-i18n="loginBtn">${i18n[currentLang].loginBtn}</button>`; }
        });

        // 8. SAVED JOBS
        window.toggleSave = async (id) => { if(!window.currentUser) return switchView('auth'); const job = window.jobs.find(j => j.id === id); await setDoc(doc(db, 'users', window.currentUser.uid, 'saved', id.toString()), job); alert("Job Saved!"); }
        async function loadSavedJobs() { if(!window.currentUser) return; const snap = await getDocs(collection(db, 'users', window.currentUser.uid, 'saved')); const list = document.getElementById('savedContainer'); list.innerHTML = ''; snap.forEach(d => { const j = d.data(); list.innerHTML += `<div class="p-4 border rounded-xl bg-white dark:bg-gray-800 flex justify-between items-center shadow-sm"><div><div class="font-bold text-gray-800 dark:text-white">${j.title}</div><div class="text-sm text-gray-500">${j.company}</div></div><a href="${j.link}" target="_blank" class="text-morocco-green font-bold text-sm border border-morocco-green px-3 py-1 rounded hover:bg-green-50">Apply</a></div>`; }); }
    </script>
