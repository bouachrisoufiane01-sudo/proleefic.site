<script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, deleteDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBsPi64Eb0GQnGjcxg6n6YRFbG-iO9K_pM",
            authDomain: "proleefic-85800.firebaseapp.com",
            projectId: "proleefic-85800",
            storageBucket: "proleefic-85800.firebasestorage.app",
            messagingSenderId: "1033605555868",
            appId: "1:1033605555868:web:577ff42f0bcfb0b6122f59",
            measurementId: "G-WJ4XKS01P0"
        };
        
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) { console.error("Firebase Init Error", e); }
        
        const i18n = {
            en: { heroTitle: "Find the job that fits your life", whatLabel: "What", whereLabel: "Where", searchPlaceholder: "Job title, keywords...", searchBtn: "Find Jobs", cvTitle: "Post your CV", cvSub: "It only takes a few seconds", uploadBtn: "Upload Resume", categories: "Job Categories", feedTitle: "Job Feed", loadMore: "Refresh Jobs", hiringNow: "Hiring Now", authTitle: "Welcome Back", authSub: "Access your profile, save jobs, and apply instantly.", backHome: "Back to Jobs", logout: "Logout", savedJobs: "Saved Jobs", easyApply: "Easy Apply", urgent: "Urgent", posted: "Posted", ago: "ago", applyOn: "Apply on", loginBtn: "Sign In", cat_prod: "Production & Manufacturing", cat_tech: "Technicians & Maintenance", cat_eng: "Engineering & Civil", cat_it: "IT & Digital", cat_sales: "Sales & Commercial", cat_admin: "Admin & Finance", cat_transport: "Transport & Logistics" },
            fr: { heroTitle: "Trouvez le job qui correspond à votre vie", whatLabel: "Quoi", whereLabel: "Où", searchPlaceholder: "Titre, mots-clés...", searchBtn: "Rechercher", cvTitle: "Déposez votre CV", cvSub: "Cela ne prend que quelques secondes", uploadBtn: "Télécharger CV", categories: "Catégories", feedTitle: "Offres d'emploi", loadMore: "Actualiser", hiringNow: "Recrute Actuellement", authTitle: "Bienvenue", authSub: "Accédez à votre profil et postulez instantanément.", backHome: "Retour aux offres", logout: "Déconnexion", savedJobs: "Offres Sauvegardées", easyApply: "Candidature Simple", urgent: "Urgent", posted: "Publié il y a", ago: "", applyOn: "Postuler sur", loginBtn: "Connexion", cat_prod: "Production & Industrie", cat_tech: "Techniciens & Maintenance", cat_eng: "Ingénierie & BTP", cat_it: "Informatique & Digital", cat_sales: "Commercial & Vente", cat_admin: "Admin & Finance", cat_transport: "Transport & Logistique" },
            ar: { heroTitle: "جد الوظيفة التي تناسب حياتك", whatLabel: "ماذا", whereLabel: "أين", searchPlaceholder: "المسمى الوظيفي...", searchBtn: "بحث", cvTitle: "ارفع سيرتك الذاتية", cvSub: "ثوانٍ فقط", uploadBtn: "تحميل السيرة الذاتية", categories: "تصنيفات الوظائف", feedTitle: "أحدث الوظائف", loadMore: "تحديث الوظائف", hiringNow: "يوظفون الآن", authTitle: "مرحباً بعودتك", authSub: "سجل الدخول لحفظ الوظائف والتقديم.", backHome: "العودة للوظائف", logout: "خروج", savedJobs: "الوظائف المحفوظة", easyApply: "تقديم سريع", urgent: "عاجل", posted: "نشر منذ", ago: "", applyOn: "التقديم عبر", loginBtn: "تسجيل الدخول", cat_prod: "الإنتاج والتصنيع", cat_tech: "الفنيين والصيانة", cat_eng: "الهندسة والبناء", cat_it: "تكنولوجيا المعلومات", cat_sales: "المبيعات والتجارة", cat_admin: "الإدارة والمالية", cat_transport: "النقل واللوجستيك" }
        };

        window.currentLang = localStorage.getItem('lang') || 'en';
        window.currentUser = null;
        window.jobs = [];

        window.onload = () => { 
            if(localStorage.getItem('theme') === 'dark') document.documentElement.classList.add('dark');
            window.setLang(window.currentLang); 
            // Force Backup Data immediately to guarantee UI population
            generateBackupData();
            // Then try to load real data
            window.initData();
        };

        window.setLang = (lang) => {
            window.currentLang = lang; localStorage.setItem('lang', lang); document.documentElement.setAttribute('dir', lang === 'ar' ? 'rtl' : 'ltr');
            document.querySelectorAll('.lang-btn').forEach(b => { b.classList.remove('bg-white', 'dark:bg-gray-700', 'text-morocco-green', 'shadow-sm'); b.classList.add('text-gray-500'); });
            const btn = document.getElementById('lang-' + lang);
            if(btn) { btn.classList.add('bg-white', 'dark:bg-gray-700', 'text-morocco-green', 'shadow-sm'); btn.classList.remove('text-gray-500'); }
            document.querySelectorAll('[data-i18n]').forEach(el => { if(i18n[lang][el.getAttribute('data-i18n')]) el.innerText = i18n[lang][el.getAttribute('data-i18n')]; });
            document.querySelectorAll('[data-placeholder]').forEach(el => { if(i18n[lang][el.getAttribute('data-placeholder')]) el.placeholder = i18n[lang][el.getAttribute('data-placeholder')]; });
            renderCategories(); if(window.jobs.length > 0) renderJobs(window.jobs);
        };

        window.toggleTheme = () => { document.documentElement.classList.toggle('dark'); localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light'); }
        window.switchView = (v) => { document.querySelectorAll('.view-section').forEach(e => e.classList.add('hidden-view')); document.getElementById(v+'View').classList.remove('hidden-view'); window.scrollTo(0,0); }
        window.openAuth = () => document.getElementById('authView').classList.remove('hidden-view');
        window.closeAuth = () => document.getElementById('authView').classList.add('hidden-view');

        window.toggleAuthMode = (mode) => {
            document.getElementById('authError').classList.add('hidden');
            if(mode === 'login') { document.getElementById('loginForm').classList.remove('hidden'); document.getElementById('signupForm').classList.add('hidden'); document.getElementById('tab-login').classList.add('bg-white', 'text-morocco-green'); document.getElementById('tab-login').classList.remove('text-gray-500'); document.getElementById('tab-signup').classList.remove('bg-white', 'text-morocco-green'); document.getElementById('tab-signup').classList.add('text-gray-500'); }
            else { document.getElementById('loginForm').classList.add('hidden'); document.getElementById('signupForm').classList.remove('hidden'); document.getElementById('tab-signup').classList.add('bg-white', 'text-morocco-green'); document.getElementById('tab-signup').classList.remove('text-gray-500'); document.getElementById('tab-login').classList.remove('bg-white', 'text-morocco-green'); document.getElementById('tab-login').classList.add('text-gray-500'); }
        }
        
        window.showError = (msg) => { const e = document.getElementById('authError'); e.classList.remove('hidden'); document.getElementById('authErrorMsg').innerText = msg.replace('Firebase: ', ''); }
        window.handlePasswordReset = () => { if(!auth) return; const email = document.getElementById('loginEmail').value; if(!email) return window.showError("Enter email first."); sendPasswordResetEmail(auth, email).then(() => alert("Email sent!")).catch(e => window.showError(e.message)); }
        window.handleEmailLogin = (e) => { e.preventDefault(); if(!auth) return; signInWithEmailAndPassword(auth, document.getElementById('loginEmail').value, document.getElementById('loginPass').value).then(() => window.switchView('profile')).catch(err => window.showError(err.message)); };
        window.handleEmailSignup = (e) => { e.preventDefault(); if(!auth) return; const name = document.getElementById('signupName').value; createUserWithEmailAndPassword(auth, document.getElementById('signupEmail').value, document.getElementById('signupPass').value).then((res) => { updateProfile(res.user, { displayName: name }); window.switchView('profile'); }).catch(err => window.showError(err.message)); };
        window.loginGoogle = () => { if(!auth) return; signInWithPopup(auth, new GoogleAuthProvider()).then(() => window.switchView('profile')).catch(e => window.showError(e.message)); }
        window.logout = () => { if(auth) signOut(auth).then(() => window.switchView('home')); }

        if(auth) {
            onAuthStateChanged(auth, (user) => {
                window.currentUser = user; const sec = document.getElementById('authSection');
                if(user && sec) { sec.innerHTML = `<button onclick="switchView('profile')" class="font-bold text-sm text-gray-700 dark:text-gray-200 hover:text-morocco-green flex items-center gap-2"><div class="w-8 h-8 rounded-full bg-morocco-red text-white flex items-center justify-center font-bold">${user.displayName?user.displayName[0]:'U'}</div> <span class="hidden sm:inline">${user.displayName || 'User'}</span></button>`; if(document.getElementById('userName')) document.getElementById('userName').innerText = user.displayName || "User"; if(document.getElementById('userEmail')) document.getElementById('userEmail').innerText = user.email; loadSavedJobs(); }
                else if(sec) { sec.innerHTML = `<button onclick="openAuth()" class="bg-morocco-green text-white px-5 py-2 rounded-lg font-bold text-sm hover:bg-morocco-darkGreen transition shadow-sm" data-i18n="loginBtn">${i18n[currentLang].loginBtn}</button>`; }
            });
        }

        // REAL DATA LOADING
        window.initData = async () => {
            const cities = ['Casablanca', 'Tanger', 'Kenitra', 'Rabat', 'El Jadida', 'Agadir', 'Fes']; 
            document.getElementById('locationFilter').innerHTML = `<option value="">${i18n[currentLang].whereLabel || 'All Cities'}</option>` + cities.map(c => `<option value="${c}">${c}</option>`).join('');
            
            try {
                const response = await fetch('jobs.json?t=' + Date.now());
                if (!response.ok) throw new Error("No file");
                const realJobs = await response.json();
                window.jobs = realJobs;
                renderJobs(window.jobs);
            } catch (e) {
                generateBackupData();
            }
        };

        function generateBackupData() {
            const types = [{ t: "Opérateur de Production", c: "cat_prod", sal: "3000 - 4500 MAD" }, { t: "Technicien de Maintenance", c: "cat_tech", sal: "4500 - 7000 MAD" }, { t: "Ingénieur Mécanique", c: "cat_eng", sal: "9000 - 13000 MAD" }, { t: "Développeur Full Stack", c: "cat_it", sal: "12000 MAD+" }, { t: "Commercial Terrain", c: "cat_sales", sal: "Fixed + Comm" }];
            const companies = ['Renault', 'Yazaki', 'OCP', 'Maroc Telecom', 'Dell'];
            const cities = ['Casablanca', 'Tanger', 'Rabat'];
            const sources = [{ name: "LinkedIn", url: "https://www.linkedin.com/jobs/search/?keywords=Maroc" }, { name: "Rekrute", url: "https://www.rekrute.com/offres.html" }, { name: "Emploi.ma", url: "https://www.emploi.ma/" }, { name: "Anapec", url: "http://www.anapec.org/" }];
            const backupJobs = [];
            for(let i=0; i<30; i++) { 
                const type = types[Math.floor(Math.random() * types.length)]; const comp = companies[Math.floor(Math.random() * companies.length)]; const src = sources[Math.floor(Math.random() * sources.length)];
                backupJobs.push({ id: Date.now() + i, title: type.t, company: comp, location: cities[Math.floor(Math.random() * cities.length)], catId: type.c, salary: type.sal, posted: Math.floor(Math.random() * 5), urgent: Math.random() > 0.8, easyApply: true, rating: "4.5", link: src.url, sourceName: src.name }); 
            }
            window.jobs = backupJobs;
            renderJobs(window.jobs);
        }

        window.filterCat = (catId) => {
            const filtered = window.jobs.filter(j => j.catId === catId);
            renderJobs(filtered);
        }

        function renderCategories() {
            const list = document.getElementById('categoryList');
            if(!list) return;
            const labels = { 'cat_prod': i18n[window.currentLang].cat_prod, 'cat_tech': i18n[window.currentLang].cat_tech, 'cat_eng': i18n[window.currentLang].cat_eng, 'cat_transport': i18n[window.currentLang].cat_transport, 'cat_it': i18n[window.currentLang].cat_it, 'cat_sales': i18n[window.currentLang].cat_sales };
        }

        // --- BETTER LOGO SYSTEM (Clearbit API + Fallback) ---
        function getCompanyLogo(companyName) {
            // Map known companies to their website domains for Clearbit API
            const domains = {
                "Renault": "renaultgroup.com", "OCP": "ocpgroup.ma", "Maroc Telecom": "iam.ma", "Dell": "dell.com", 
                "Yazaki": "yazaki-group.com", "Stellantis": "stellantis.com", "Attijariwafa": "attijariwafabank.com", 
                "Inwi": "inwi.ma", "Centrale Danone": "danone.com", "BIM": "bim.ma", "Marjane": "marjane.ma",
                "Capgemini": "capgemini.com", "Oracle": "oracle.com", "Lear": "lear.com", "Alten": "alten.com",
                "Leyton": "leyton.com", "CGI": "cgi.com", "Orange": "orange.ma"
            };

            // Check if we know the domain
            const key = Object.keys(domains).find(k => companyName.includes(k));
            
            if (key) {
                const url = `https://logo.clearbit.com/${domains[key]}`;
                // The ONERROR event is the magic. If the image fails, it hides itself and shows the next element (the letter div)
                return `
                <div class="w-12 h-12 shrink-0 relative">
                    <img src="${url}" class="w-full h-full object-contain rounded bg-white border border-gray-100 p-1" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div class="w-full h-full rounded bg-gray-100 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 flex items-center justify-center font-bold text-gray-500 text-xl uppercase hidden">
                        ${companyName.charAt(0)}
                    </div>
                </div>`;
            }
            
            // Default Fallback
            return `<div class="w-12 h-12 shrink-0 rounded bg-gray-100 dark:bg-gray-700 flex items-center justify-center font-bold text-gray-500 text-xl uppercase border border-gray-200 dark:border-gray-600">${companyName.charAt(0)}</div>`;
        }

        function renderJobs(arr) {
            const container = document.getElementById('jobListings');
            if(!container) return;
            document.getElementById('jobCount').innerText = arr.length + ' jobs';
            container.innerHTML = arr.map((j, idx) => {
                const timeText = j.posted === 0 ? (currentLang === 'ar' ? 'اليوم' : 'Today') : `${currentLang === 'ar' ? '' : i18n[currentLang].posted} ${j.posted}d ${i18n[currentLang].ago}`;
                let adBlock = ''; if(idx === 4) { adBlock = `<div class="ad-container py-4 my-4"><span class="ad-label">Sponsored</span><ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-3965710509874164" data-ad-slot="REPLACE_WITH_SLOT_ID"></ins><script>(adsbygoogle = window.adsbygoogle || []).push({});<\/script></div>`; }
                
                const logoHtml = getCompanyLogo(j.company); // Use the new logo function

                return `${adBlock}<div class="bg-white dark:bg-dark-card p-5 rounded-xl border border-gray-200 dark:border-gray-700 hover:border-morocco-green hover:shadow-lg transition-all animate-fade-in group relative cursor-pointer" onclick="window.open('${j.link}', '_blank')">${j.urgent ? `<span class="absolute top-0 right-0 bg-red-100 text-morocco-red text-[10px] font-bold px-2 py-1 rounded-bl-lg rounded-tr-lg uppercase tracking-wide"><i class="fa-solid fa-fire mr-1"></i>${i18n[currentLang].urgent}</span>` : ''}<div class="flex gap-4">${logoHtml}<div class="flex-1"><h3 class="font-bold text-lg text-gray-800 dark:text-white group-hover:text-morocco-green transition-colors mb-0.5">${j.title}</h3><div class="text-sm text-gray-700 dark:text-gray-300 mb-2">${j.company} <span class="text-xs text-gray-400">★ ${j.rating}</span></div><div class="text-sm text-gray-500 mb-3 flex items-center gap-1"><i class="fa-solid fa-location-dot text-xs"></i> ${j.location}</div><div class="flex flex-wrap gap-2 mb-3"><span class="bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 text-xs font-bold px-2 py-1 rounded flex items-center gap-1"><i class="fa-solid fa-money-bill-wave"></i> ${j.salary}</span></div><div class="text-xs text-gray-400 mb-4">${timeText}</div><div class="flex gap-3"><a href="${j.link}" target="_blank" onclick="event.stopPropagation()" class="flex-1 bg-morocco-green text-white text-center py-2.5 rounded-lg text-sm font-bold hover:bg-morocco-darkGreen transition shadow-sm flex items-center justify-center gap-2">${i18n[currentLang].applyOn} ${j.sourceName} <i class="fa-solid fa-arrow-up-right-from-square text-xs"></i></a><button onclick="window.toggleSave(${j.id}); event.stopPropagation()" class="px-4 py-2 border border-gray-200 dark:border-gray-600 rounded-lg text-gray-400 hover:text-morocco-red hover:border-morocco-red transition"><i class="fa-regular fa-heart text-lg"></i></button></div></div></div></div>`;
            }).join('');
        }

        window.filter = () => { const term = document.getElementById('mainSearch').value.toLowerCase(); const loc = document.getElementById('locationFilter').value; renderJobs(window.jobs.filter(j => (j.title.toLowerCase().includes(term) || j.company.toLowerCase().includes(term)) && (loc === '' || j.location === loc))); };
        window.toggleSave = async (id) => { if(!auth || !window.currentUser) return window.openAuth(); const job = window.jobs.find(j => j.id === id); await setDoc(doc(db, 'users', window.currentUser.uid, 'saved', id.toString()), job); alert("Job Saved!"); }
        async function loadSavedJobs() { if(!auth || !window.currentUser) return; const snap = await getDocs(collection(db, 'users', window.currentUser.uid, 'saved')); const list = document.getElementById('savedContainer'); list.innerHTML = ''; snap.forEach(d => { const j = d.data(); list.innerHTML += `<div class="p-4 border rounded-xl bg-white dark:bg-gray-800 flex justify-between items-center shadow-sm"><div><div class="font-bold text-gray-800 dark:text-white">${j.title}</div><div class="text-sm text-gray-500">${j.company}</div></div><a href="${j.link}" target="_blank" class="text-morocco-green font-bold text-sm border border-morocco-green px-3 py-1 rounded hover:bg-green-50">Apply</a></div>`; }); }
    </script>
